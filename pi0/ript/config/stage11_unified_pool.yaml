# Stage 11 Unified Sample Pool Configuration
# æµ‹è¯•ç»Ÿä¸€æ ·æœ¬æ± è®­ç»ƒæ–¹æ³•ï¼šä½ æƒ³è¦çš„ç†æƒ³æ¶æ„
# ğŸ”¥ ä¸åŸç‰ˆRIPTå¯¹é½çš„é…ç½®

defaults:
  - paths  # ğŸ”¥ å¼•å…¥pathsé…ç½®
  - _self_

exp_name: stage11_unified_pool_test

# === åŸºæœ¬è·¯å¾„é…ç½®ï¼ˆä½¿ç”¨paths.yamlä¸­çš„é…ç½®ï¼‰===
policy_path: "/zhaohan/ZJH/openpi_pytorch/checkpoints/pi0_libero_pytorch"
output_dir: "/zhaohan/ZJH/openpi_pytorch/experiments/stage11_unified_pool"  # ğŸ”¥ ç›´æ¥ä½¿ç”¨ç»å¯¹è·¯å¾„
data_prefix: "/zhaohan/ZJH/openpi_pytorch/datasets"  # ğŸ”¥ ç›´æ¥ä½¿ç”¨ç»å¯¹è·¯
å¾„
# === ä»»åŠ¡é…ç½® ===
task:
  benchmark_name: "libero_spatial"         # ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨å°å†™æ ¼å¼
  task_names_to_use:
    - "pick_up_the_black_bowl_from_table_center_and_place_it_on_the_plate"    # ğŸ”¥ ä¿®å¤ï¼šä»LIBEROå®˜æ–¹ä»»åŠ¡æ˜ å°„è·å–
  num_parallel_envs: 4  # ğŸ”¥ å•ç¯å¢ƒé¿å…å†…å­˜é—®é¢˜
  max_episode_length: 100  # ğŸ”¥ è¿›ä¸€æ­¥é™åˆ¶episodeé•¿åº¦å‡å°‘æ ·æœ¬æ•°

# ğŸ”¥ LIBEROæ•°æ®é›†é…ç½®ï¼ˆä¸åŸç‰ˆRIPTå¯¹é½ï¼‰
use_libero_demos: true                     # å¯ç”¨LIBERO demoåŠ è½½
libero_data_prefix: "/zhaohan/ZJH/openpi_pytorch/datasets"   # ğŸ”¥ ç›´æ¥ä½¿ç”¨ç»å¯¹è·¯å¾„
benchmark_name: "libero_spatial"          # ä¸task.benchmark_nameä¿æŒä¸€è‡´

# ğŸ”¥ æ•°æ®é›†é…ç½®ï¼ˆä¸åŸç‰ˆRIPTå¯¹é½ï¼‰
dataset:
  seq_len: 600
  frame_stack: 1
  obs_seq_len: 1
  load_obs_for_pretrain: true
  load_next_obs: true
  get_pad_mask: true
  load_state: true  # ğŸ”¥ å…³é”®ï¼šåŠ è½½MuJoCoçŠ¶æ€æ•°æ®
  # ğŸ”¥ æ·»åŠ ç¼ºå¤±çš„é…ç½®é¡¹
  _target_: pi0.ript.utils.libero_utils_ript_aligned.build_dataset_ript_aligned

# === ç®—æ³•é…ç½® ===
algo:
  demo_batch_size: 2
  rloo_batch_size: 4  # ğŸ”¥ å‡å°‘episodesæ•°é‡é¿å…OOM
  lr: 1e-5
  gradient_accumulation_steps: 4  # ğŸ”¥ å¢åŠ ç´¯ç§¯æ­¥æ•°è¡¥å¿å°batch
  collection_cfg_scale: 1.01
  cfg_uncond_weight: 0.1
  rollout_skip_threshold: 3
  enable_rollout_stats_tracking: false
  use_val_init: false

# === ç­–ç•¥é…ç½® ===
policy:
  cfg_enabled: true  # å¯ç”¨CFGæµ‹è¯•
  train_expert_only: true
  freeze_vision_encoder: true

# === ğŸš€ æ•°æ®å¤„ç†é…ç½® - å¯ç”¨ç»Ÿä¸€æ ·æœ¬æ±  ===
# æ³¨æ„ï¼šdataseté…ç½®å·²åœ¨ä¸Šé¢å®šä¹‰ï¼Œè¿™é‡Œæ·»åŠ é¢å¤–çš„å¤„ç†é…ç½®
data_processing:
  num_init_states: 1
  state_dim: 8
  
  # å¯ç”¨SO100å¤„ç† + ç»Ÿä¸€æ ·æœ¬æ± 
  use_so100_processing: true
  
  # Legacyé…ç½®ï¼ˆSO100æ¨¡å¼ä¸‹å¿½ç•¥ï¼‰
  windowing_mode: last
  window_stride: 10
  max_windows_per_episode: 1

# === è®­ç»ƒé…ç½® ===
training:
  num_train_steps: 3  # å¿«é€Ÿæµ‹è¯•
  seed: 42
  n_steps: 3
  rollout_steps: 1
  log_interval: 1
  save_interval: 1
  load_obs: true
  save_freq: 1

# === æ—¥å¿—é…ç½® ===
logging:
  use_wandb: false
  log_freq: 1
  group: null
  mode: online
  project: "openpi-ript-vla"
  resume: true
  save_code: true

# === ç‰¹æ€§å¼€å…³ - ç®€åŒ–é…ç½® ===
features:
  use_ript_vla_runner: false
  enable_parallel_envs: true      # ç¦ç”¨å¹¶è¡Œç¯å¢ƒé¿å…å¡æ­»
  enable_true_parallel_envs: true
  enable_smart_sampling: false
<<<<<<< HEAD
  use_parallel_init_state: true  # ğŸ”¥ é‡æ–°å¯ç”¨å¹¶è¡ŒçŠ¶æ€è®¾ç½®ï¼ˆå·²ä¿®å¤æ ¼å¼é—®é¢˜ï¼‰
=======
  use_parallel_init_state: true
>>>>>>> merge
  save_video: false
  enable_file_counter: false
  adaptive_cfg: false
  early_stop_percentage: 1.0

  # ğŸ”¥ æ–°å¢ï¼šå¹¶è¡Œç¯å¢ƒåˆå§‹çŠ¶æ€åŒæ­¥æ§åˆ¶
  parallel_env_sync:
    enabled: true                    # å¯ç”¨æ™ºèƒ½éšæœºé€‰æ‹©
    fixed_init_state_id: -1         # ğŸ² -1è¡¨ç¤ºéšæœºé€‰æ‹©ï¼Œ>=0è¡¨ç¤ºå›ºå®šID
    verify_sync: false              # éšæœºæ¨¡å¼ä¸‹ä¸éªŒè¯åŒæ­¥æ€§
    sync_tolerance: 1e-6            # çŠ¶æ€å·®å¼‚å®¹å¿åº¦
    random_sampling: true           # ğŸ”¥ æ–°å¢ï¼šå¯ç”¨éšæœºé‡‡æ ·æ¨¡å¼
  
  # åŠ¨æ€é‡‡æ ·é…ç½®
  dynamic_sampling:
    enabled: true

# === ğŸ¯ ç»Ÿä¸€æ ·æœ¬æ± é…ç½®è¯´æ˜ ===
# 
# æ–°çš„è®­ç»ƒæµç¨‹ï¼š
# 1. æ”¶é›†3ä¸ªepisodes (rloo_batch_size=3)
# 2. ç»Ÿä¸€ç”Ÿæˆæ‰€æœ‰æ ·æœ¬åˆ°æ ·æœ¬æ± 
# 3. æ‰“æ•£æ ·æœ¬é¡ºåºï¼Œç ´é™¤ç›¸å…³æ€§
# 4. æŒ‰å›ºå®šbatch_size=32åˆ‡åˆ†æ ·æœ¬
# 5. æ ‡å‡†æ¢¯åº¦ç´¯ç§¯è®­ç»ƒ
#
# é¢„æœŸæ•ˆæœï¼š
# - å›ºå®šbatchå¤§å°ï¼Œæ ‡å‡†æ·±åº¦å­¦ä¹ èŒƒå¼
# - æ ·æœ¬éšæœºåŒ–ï¼Œæ›´å¥½çš„è®­ç»ƒç¨³å®šæ€§
# - ç®€åŒ–çš„ä¼˜åŠ¿ä¼ æ’­ï¼Œæ— å¤æ‚æ˜ å°„
# - æ›´é«˜çš„æ•°æ®åˆ©ç”¨ç‡

# === è®­ç»ƒé…ç½®ï¼ˆä¸åŸç‰ˆRIPTå¯¹é½ï¼‰- å·²åˆå¹¶åˆ°ä¸Šé¢çš„trainingéƒ¨åˆ† ===

# === æ•°æ®åŠ è½½é…ç½®ï¼ˆä¸åŸç‰ˆRIPTå¯¹é½ï¼‰===
train_dataloader:
  batch_size: 6  # ğŸ”¥ ä¸åŸç‰ˆRIPTå¯¹é½
  shuffle: true
  num_workers: 6
  persistent_workers: false
  pin_memory: true

# === æ—¥å¿—é…ç½®ï¼ˆä¸åŸç‰ˆRIPTå¯¹é½ï¼‰- å·²åˆå¹¶åˆ°ä¸Šé¢çš„loggingéƒ¨åˆ† ===

# === å¯è°ƒè¶…å‚æ•°ï¼ˆé¿å…ç¡¬ç¼–ç ï¼‰ ===
unified_pool_batch_size: 8   # ç»Ÿä¸€æ ·æœ¬æ± æ¯ä¸ªbatchå¤§å° - ä¿®å¤æ˜¾å­˜ç´¯ç§¯åé€‚å½“æå‡
unified_pool_shuffle: true     # æ˜¯å¦åœ¨æ ·æœ¬æ± å±‚é¢æ‰“æ•£æ ·æœ¬é¡ºåº

# ğŸ”¥ ä¸åŸç‰ˆRIPTå¯¹é½çš„å‚æ•°è¯´æ˜ï¼š
# 1. rloo_batch_size: æ§åˆ¶æ¯æ¬¡æ”¶é›†çš„episodesæ•°é‡
# 2. unified_pool_batch_size: æ§åˆ¶è®­ç»ƒæ—¶çš„batchå¤§å°
# 3. gradient_accumulation_steps: æ§åˆ¶æ¢¯åº¦ç´¯ç§¯
# 4. collection_cfg_scale: æ§åˆ¶CFGå¼•å¯¼å¼ºåº¦
# 5. load_state: true - å…³é”®ï¼ŒåŠ è½½MuJoCoçŠ¶æ€æ•°æ®
