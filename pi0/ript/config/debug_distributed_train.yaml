# 分布式训练调试配置 - 最小化参数便于快速测试
exp_name: pi0_distributed_debug_test

# --- 路径配置 ---
policy_path: "/zhaohan/ZJH/openpi_pytorch/checkpoints/pi0_libero_pytorch"
output_dir: "./pi0/ript/output/distributed_debug"  
norm_stats_path: "/zhaohan/ZJH/openpi_pytorch/lerobot_dataset/norm_stats.json"

# --- 分布式配置 ---
distributed:
  enabled: true
  backend: 'nccl'
  timeout_seconds: 3600              # 1小时超时（调试时缩短）
  find_unused_parameters: false
  bucket_cap_mb: 25
  
# --- 数据并行配置 ---
data_parallel:
  sync_every_n_steps: 2              # 更频繁的同步以便调试
  enable_gradient_checkpointing: false
  async_data_loading: true

# --- 任务分片配置 ---
task_distribution:
  enable_task_sharding: true
  balance_tasks_across_gpus: true
  min_tasks_per_gpu: 1

# --- 任务和环境配置 ---
task:
  benchmark_name: "libero_spatial" 
  task_name: 9
  task_names_to_use: null
  num_parallel_envs: 4                # 🔥 启用4个并行环境
  rollouts_per_env: 4                 # 每个环境运行4个轨迹
  max_episode_length: 100             # 缩短episode长度

# --- 算法配置（调试参数） ---
algo:
  rloo_batch_size: 2                 # 减小batch大小
  num_epochs: 2                      # 减少epochs
  data_batch_size: 4                 # 减小总batch数
  gradient_accumulation_steps: 1     # 简化梯度累积
  lr: 1e-5
  grad_norm_clip: 1.0
  
  enable_dynamic_sampling: true
  enable_rollout_stats_tracking: true
  rollout_skip_threshold: 2          # 降低跳过阈值
  rollout_stats_path: "./pi0/ript/output/distributed_debug/rollout_stats.json"
  use_val_init: false

# --- 训练配置（调试参数） ---  
training:
  num_train_steps: 3                 # 只运行3步用于调试
  seed: 42
  save_freq: 2
  save_best: false                   # 调试时不保存最佳模型
  use_mixed_precision: false
  
  optimizer:
    type: "AdamW"
    weight_decay: 0.01
    momentum: 0.9
    beta1: 0.9
    beta2: 0.999

# --- 日志配置 ---
logging:
  use_wandb: false
  wandb_project: "ript-pi0-debug"
  wandb_entity: null
  wandb_mode: "offline"
  log_freq: 1
  log_gradients: false
  log_dir: "./pi0/ript/output/distributed_debug/logs"

# --- 增强采样配置 ---
enhanced_sampling:
  enable_smart_filtering: true
  max_sampling_attempts: 5           # 大幅减少尝试次数
  debug_sampling: true               # 启用详细调试
  save_videos: false                 # 调试时不保存视频
  video_dir: "rollout_videos_debug"

# --- 性能优化配置 ---
performance:
  enable_torch_compile: false
  max_memory_per_gpu_gb: 12          # 降低内存限制
  prefetch_factor: 1
  num_workers: 2
  pin_memory: true
  
# --- 容错和恢复配置 ---
fault_tolerance:
  enable_checkpointing: false        # 调试时不保存检查点
  checkpoint_interval: 5
  max_checkpoints_to_keep: 1
  auto_resume: false
  resume_from_latest: false

# --- 调试配置 ---
debug:
  profile_performance: true          # 启用性能分析
  log_memory_usage: true            # 记录内存使用
  save_intermediate_results: true   # 保存中间结果
  distributed_debug: true           # 启用分布式调试