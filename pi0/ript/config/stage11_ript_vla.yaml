# Stage 11 RIPT-VLA测试配置 - 轻量CFG稳定版
# 测试轻量CFG增强的性能 (cfg_scale=1.25) + 稳定模拟并行

exp_name: stage11_ript_vla_cfg125_fixed

# === 基本路径配置 ===
policy_path: "/zhaohan/ZJH/openpi_pytorch/checkpoints/pi0_libero_pytorch"
output_dir: "./output/stage11_ript_vla"

# === 任务配置 ===
task:
  benchmark_name: "libero_goal"
  task_names_to_use:
    - "put_the_bowl_on_the_stove"
  num_parallel_envs: 4  # 🚀 测试并行环境
  max_episode_length: null  # 短episode快速测试

# === 算法配置 ===
algo:
  demo_batch_size: 1   # 🔥 解耦：每步收集1组（防OOM第一步）
  rloo_batch_size: 4   # 每组4个样本（从8降到4，减少显存压力）
  lr: 1e-5
  gradient_accumulation_steps: 16  # 🔥 提高梯度累积：保持有效batch size
  collection_cfg_scale: 1.0        # 🔥 收集时关闭CFG（训练时再开启）
  cfg_uncond_weight: 0.1           # 训练时无条件分支权重
  # RolloutGenerator配置
  rollout_skip_threshold: 3
  enable_rollout_stats_tracking: true
  rollout_stats_path: "./output/stage11_ript_vla/rollout_stats.json"
  use_val_init: false

# === 策略配置 ===
policy:
  cfg_enabled: true                # 🚨 启用CFG功能（训练时使用）
  train_expert_only: true          # 专家头训练模式
  freeze_vision_encoder: true      # 🔥 新增：冻结视觉编码器（减少显存和计算）

# === 数据集配置 ===
dataset:
  num_init_states: 1  # 🔥 与demo_batch_size对齐
  state_dim: 8  # 状态维度
  # 🔥 关键修复：关闭滑动窗口（防OOM）
  windowing_mode: last      # 只用最后窗口，不再滑动
  window_stride: 999        # 大步长确保不重叠
  max_windows_per_episode: 1 # 每条轨迹最大窗口数=1

# === 训练配置 ===
training:
  num_train_steps: 2  # 只训练2步测试
  seed: 42
  save_freq: 1

# === 日志配置 ===
logging:
  use_wandb: false
  log_freq: 1

# === 特性开关 ===
features:
  use_ript_vla_runner: false  # 关闭RIPT-VLA runner，使用LIBEROEnvRunner
  enable_parallel_envs: true  # 开启并行环境（向量化）
  enable_true_parallel_envs: false  # 🔥 关闭真正多进程并行（防止内存问题）
  enable_smart_sampling: true      # Runner日志用的智能采样开关
  use_parallel_init_state: true    # 🔥 开启：并行时调用set_init_state
  save_video: false               # 🔥 关闭视频保存（减少显存占用）
  
  # === 🔥 增强功能开关 ===
  enable_file_counter: true        # 开启文件计数器（分布式训练样本统计）
  adaptive_cfg: false              # 关闭自适应CFG（CFG已禁用）
  early_stop_percentage: 0.8       # 文件计数器早停阈值百分比
  
  # === 🔥 CFG自适应调整配置 ===
  adaptive_cfg_config:
    min_cfg: 1.0                   # CFG最小值
    max_cfg: 3.0                   # CFG最大值
    cfg_step: 0.2                  # CFG调整步长
    low_success_threshold: 0.2     # 低成功率阈值（低于此值降低CFG）
    high_success_threshold: 0.9    # 高成功率阈值（高于此值提升CFG）
  
  # === 🔥 CFG扫描评估配置 ===
  cfg_sweep_config:
    enabled: true                  # 是否启用CFG扫描评估
    scales: [1.0, 1.25, 1.5, 2.0, 3.0]  # 扫描的CFG强度列表
    eval_episodes: 3               # 每个CFG强度的评估轮数
  
  # 动态采样配置（RIPT风格）
  dynamic_sampling:
    enabled: true                  # 开启动态采样
    p_min: 0.1                    # 成功率下限（备用，RIPT风格主要检查全成功/全失败）
    p_max: 0.9                    # 成功率上限（备用，RIPT风格主要检查全成功/全失败）
    # 注：RIPT风格使用简单的全成功/全失败检查，不需要平滑窗口